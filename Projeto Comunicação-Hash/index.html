<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Telemetria </title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f9; color: #333; padding: 20px; }
        .container { max-width: 700px; margin: auto; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1, h3 { color: #0056b3; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        #status { font-style: italic; text-align: center; padding: 10px; border-radius: 5px; margin-top: 20px; transition: background-color 0.3s; }
        .status-ok { background-color: #e8f5e9; color: #2e7d32; }
        .status-falha { background-color: #ffebee; color: #c62828; }
        .status-conectando { background-color: #e3f2fd; color: #0d47a1; }
        p { line-height: 1.6; font-size: 1.2em; }
        strong { color: #555; }
        span { color: #007bff; font-weight: bold; font-family: "Courier New", Courier, monospace; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Dashboard de Telemetria</h1>
        <h3>Dados em Tempo Real</h3>
        <p><strong>Acelerador:</strong> <span id="acelerador">---</span></p>
        <p><strong>Freio:</strong> <span id="freio">---</span></p>
        <p><strong>Status de Integridade:</strong> <span id="integridade">---</span></p>
        
        <div id="status" class="status-conectando">Conectando ao servidor...</div>
    </div>

    <script>
        const statusDiv = document.getElementById('status');
        const aceleradorSpan = document.getElementById('acelerador');
        const freioSpan = document.getElementById('freio');
        const integridadeSpan = document.getElementById('integridade');

        function connectWebSocket() {
            const socket = new WebSocket('ws://localhost:8080');

            socket.onopen = () => {
                console.log('Conexão WebSocket estabelecida!');
                statusDiv.textContent = 'Conectado! Aguardando dados...';
                statusDiv.className = 'status-ok';
            };

            socket.onmessage = (event) => {
                console.log('Dados recebidos:', event.data);
                
                // 1. Converte a string JSON em um ARRAY de objetos
                const logs = JSON.parse(event.data);

                // Se o array estiver vazio, não faz nada
                if (logs.length === 0) return;

                // 2. Pega o último registro do array (o mais recente)
                const ultimoRegistro = logs[logs.length - 1];

                // 3. Pega a string de dados (ex: "1023,512") e a separa em um array
                const valores = ultimoRegistro.data.split(','); // ["1023", "512"]
                
                // 4. Atualiza os elementos HTML com os valores corretos
                aceleradorSpan.textContent = valores[0]; // Primeiro valor
                freioSpan.textContent = valores[1];    // Segundo valor
                integridadeSpan.textContent = ultimoRegistro.integrity_status;

                // Atualiza o status geral
                statusDiv.textContent = 'Dados atualizados em: ' + ultimoRegistro.timestamp;
                if (ultimoRegistro.integrity_status === 'OK') {
                    integridadeSpan.style.color = '#2e7d32'; // Verde
                } else {
                    integridadeSpan.style.color = '#c62828'; // Vermelho
                }
            };

            socket.onclose = () => {
                console.log('Conexão fechada. Tentando reconectar em 3 segundos...');
                statusDiv.textContent = 'Desconectado. Tentando reconectar...';
                statusDiv.className = 'status-falha';
                setTimeout(connectWebSocket, 3000);
            };

            socket.onerror = (error) => {
                console.error('Erro no WebSocket:', error);
                statusDiv.textContent = 'Erro na conexão.';
                statusDiv.className = 'status-falha';
            };
        }

        connectWebSocket();
    </script>
</body>
</html>
